name: Nightly Release

# Ensure the workflow has write permission to repository contents so the release can be created
permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  create-nightly-release:
    runs-on: windows-latest
    # Redundant but explicit: job-level permissions inherit from workflow-level
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install PySide6 PySide6-Fluent-Widgets PyInstaller pywin32 pywebview

      - name: Update version.json
        shell: pwsh
        run: |
          $date = Get-Date -Format "yyyy.MM.dd"
          $version = "$date-nightly.1"
          $json = Get-Content -Path version.json | ConvertFrom-Json
          $json.version = $version
          $json | ConvertTo-Json | Set-Content -Path version.json
          Write-Host "Updated version.json to $version"
          Add-Content -Path $env:GITHUB_ENV -Value "VERSION=$version"

      - name: Build exe
        shell: pwsh
        run: |
          python build_nuitka.py

      - name: Verify built exe exists
        id: verify_asset
        shell: pwsh
        run: |
          if (Test-Path -Path "Kazuha.exe") {
            Write-Host "Found asset: Kazuha.exe"
            Add-Content -Path $env:GITHUB_ENV -Value "ASSET_PATH=Kazuha.exe"
          } else {
            Write-Error "Kazuha.exe not found. Build may have failed."
            exit 1
          }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kazuha-Nightly-${{ env.VERSION }}
          path: ${{ env.ASSET_PATH }}
          if-no-files-found: error

      - name: Create nightly release and upload asset
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: nightly
          name: Nightly Build (${{ env.VERSION }})
          body: |
            Kazuha Nightly Build
            构建日期: ${{ env.VERSION }}
            
            这是自动构建的开发版本，不保证稳定性。
          prerelease: true
          draft: false
          makeLatest: true
          files: ${{ env.ASSET_PATH }}
          token: ${{ secrets.GITHUB_TOKEN }}
