<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Dialog</title>
  <style>
    :root {
      --bg-body: #F3F3F3;
      --bg-app: #FFFFFF;
      --text-primary: #191919;
      --text-secondary: #666666;
      --accent-blue: #3275F5;
      --divider: rgba(0, 0, 0, 0.05);
      --card-bg: #F8F9FB;
      --btn-cancel-bg: #F5F5F5;
      --font-stack: "MiSans Latin", "HarmonyOS Sans SC", "SF Pro", "苹方-简", "PingFang SC", "Segoe UI", "Microsoft YaHei", system-ui, -apple-system, sans-serif;
    }

    [data-theme="dark"] {
      --bg-body: #121212;
      --bg-app: #1E1E1E;
      --text-primary: #E5E5E5;
      --text-secondary: #909090;
      --accent-blue: #4A85F6;
      --divider: rgba(255, 255, 255, 0.08);
      --card-bg: rgba(255, 255, 255, 0.05);
      --btn-cancel-bg: #2C2C2C;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      user-select: none;
      -webkit-drag: none;
    }

    html, body {
      background: var(--bg-body) !important;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    body {
      color: var(--text-primary);
      font-family: var(--font-stack);
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-body) !important;
    }

    .rtl {
      direction: rtl;
    }

    .rtl .dialog-container,
    .rtl .dialog-title,
    .rtl .dialog-text {
      text-align: right;
    }

    .rtl .dialog-buttons {
      flex-direction: row-reverse;
    }

    .dialog-window {
      background: var(--bg-body);
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .drag-area {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40px;
      -webkit-app-region: drag;
      z-index: 100;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px 24px 20px 24px;
      gap: 16px;
      position: relative;
    }

    .title {
      font-size: 17px;
      font-weight: 600;
      line-height: 1.4;
      color: var(--text-primary);
      padding: 0 4px;
    }

    .content-container {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--bg-app);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid var(--divider);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.03);
    }

    [data-theme="dark"] .content-container {
      background: var(--bg-app);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
    }

    .text-content {
      font-size: 14.5px;
      line-height: 1.6;
      color: var(--text-primary);
      white-space: pre-wrap;
    }

    .error-card {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-all;
      background: rgba(0, 0, 0, 0.02);
      padding: 12px;
      border-radius: 8px;
      max-height: 360px;
      overflow: auto;
    }

    [data-theme="dark"] .error-card {
      background: rgba(255, 255, 255, 0.03);
    }

    .footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 0 4px;
    }

    .btn {
      min-width: 88px;
      height: 34px;
      border-radius: 17px;
      border: none;
      font-size: 13.5px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      outline: none;
    }

    .btn-cancel {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--divider);
    }

    .btn-cancel:hover {
      background: rgba(0, 0, 0, 0.04);
      color: var(--text-primary);
    }

    [data-theme="dark"] .btn-cancel:hover {
      background: rgba(255, 255, 255, 0.06);
    }

    .btn-confirm {
      background: transparent;
      color: var(--accent-blue);
      border: 1px solid var(--accent-blue);
    }

    .btn-confirm:hover {
      background: var(--accent-blue);
      color: #FFFFFF;
    }

    .btn:active {
      transform: translateY(0);
      filter: brightness(0.9);
    }

    .dev-watermark {
      position: fixed;
      right: 16px;
      bottom: 12px;
      font-size: 11px;
      color: var(--text-secondary);
      text-align: right;
      pointer-events: none;
      line-height: 1.4;
      white-space: pre-line;
      z-index: 9999;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--divider);
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="dialog-window">
    <div class="drag-area"></div>
    <div class="container">
      <div id="title" class="title">提示</div>
      <div class="content-container">
        <div id="text-content" class="text-content"></div>
        <div id="error-card" class="error-card" style="display: none;"></div>
      </div>
      <div class="footer">
        <button id="btn-cancel" class="btn btn-cancel" onclick="onCancel()">取消</button>
        <button id="btn-confirm" class="btn btn-confirm" onclick="onConfirm()">确认</button>
      </div>
    </div>
  </div>

  <div id="dev-watermark" class="dev-watermark" style="display: none;"></div>

  <script>
    const titleEl = document.getElementById('title');
    const textEl = document.getElementById('text-content');
    const errorEl = document.getElementById('error-card');
    const btnCancel = document.getElementById('btn-cancel');
    const btnConfirm = document.getElementById('btn-confirm');

    const I18N = {
      "zh-CN": {
        "dialog.generic.ok": "确认",
        "dialog.generic.cancel": "取消",
        "dialog.crash.title": "程序崩溃了 (´；ω；`)",
        "dialog.crash.confirm": "关闭",
        "dialog.crash.cancel": "复制错误",
        "dialog.multiInstance.title": "检测到程序已在运行",
        "dialog.multiInstance.text": "检测到已有一个实例在运行。\n\n选择要执行的操作：",
        "dialog.multiInstance.confirm": "终止旧的并运行",
        "dialog.multiInstance.cancel": "同时退出",
        "testDialog.title": "测试对话框",
        "testDialog.confirm": "我知道了",
        "testDialog.cancel": "关闭",
        "dialog.fontWarning.title": "自定义字体风险提示",
        "dialog.fontWarning.text": "启用自定义字体可能会导致以下问题：\n\n1. 文本排版错乱、控件被撑破或换行异常\n2. 部分字符、符号或多语言内容缺少字形，显示为方块/问号\n3. 在不同 DPI / 缩放比例下出现渲染模糊或对齐不齐\n4. 在特定系统环境或 PowerPoint 版本中表现与开发环境不一致\n\n因使用自定义字体导致的显示异常、崩溃或演示事故，开发者概不负责，也不提供针对性的技术支持。",
        "dialog.fontWarning.confirm": "我已知晓并愿意自行承担风险",
        "general.devWatermark": "开发中版本/技术预览版本\n不保证最终品质 （{version}）"
      },
      "zh-TW": {
        "dialog.generic.ok": "確認",
        "dialog.generic.cancel": "取消",
        "dialog.crash.title": "程式崩潰了 (´；ω；`)",
        "dialog.crash.confirm": "關閉",
        "dialog.crash.cancel": "複製錯誤",
        "dialog.multiInstance.title": "檢測到程式已在執行",
        "dialog.multiInstance.text": "檢測到已有一個實例在執行。\n\n請選擇要執行的操作：",
        "dialog.multiInstance.confirm": "終止舊實例並啟動",
        "dialog.multiInstance.cancel": "同時退出",
        "testDialog.title": "測試對話框",
        "testDialog.confirm": "我知道了",
        "testDialog.cancel": "關閉",
        "dialog.fontWarning.title": "自訂字型風險提示",
        "dialog.fontWarning.text": "啟用自訂字型可能會導致以下問題：\n\n1. 文字排版錯亂、控制項被撐破或換行異常\n2. 部分字元、符號或多語言內容缺少字形，顯示為方塊／問號\n3. 在不同 DPI／縮放比例下出現渲染模糊或對齊不齊\n4. 在特定系統環境或 PowerPoint 版本中表現與開發環境不一致\n\n因使用自訂字型所造成的顯示異常、當機或簡報事故，開發者概不負責，也不提供個別的技術支援。",
        "dialog.fontWarning.confirm": "我已知曉並願意自行承擔風險",
        "general.devWatermark": "開發中版本/技術預覽版本\n不保證最終品質 （{version}）"
      },
      "ja-JP": {
        "dialog.generic.ok": "確認",
        "dialog.generic.cancel": "キャンセル",
        "dialog.crash.title": "プログラムがクラッシュしました (´；ω；`)",
        "dialog.crash.confirm": "閉じる",
        "dialog.crash.cancel": "エラーをコピー",
        "dialog.multiInstance.title": "すでにプログラムが実行中です",
        "dialog.multiInstance.text": "既に別のインスタンスが実行されています。\n\n実行する操作を選択してください:",
        "dialog.multiInstance.confirm": "古いインスタンスを終了して起動",
        "dialog.multiInstance.cancel": "両方終了する",
        "testDialog.title": "テストダイアログ",
        "testDialog.confirm": "了解しました",
        "testDialog.cancel": "閉じる",
        "dialog.fontWarning.title": "カスタムフォントに関する注意",
        "dialog.fontWarning.text": "カスタムフォントを有効にすると、次のような問題が発生する可能性があります。\n\n1. 文字のレイアウトが崩れ、コントロールがはみ出したり改行がおかしくなる\n2. 一部の文字・記号・多言語テキストにグリフがなく、四角や「?」として表示される\n3. DPI や表示スケールの違いにより、文字がにじんだり位置がずれたりする\n4. 特定のシステム環境や PowerPoint バージョンでは、開発環境と表示結果が一致しない\n\nカスタムフォントの使用によって生じた表示異常・クラッシュ・プレゼンテーション上のトラブルについて、開発者は一切の責任を負わず、個別の技術サポートも提供しません。",
        "dialog.fontWarning.confirm": "内容を理解し、自己責任で続行します",
        "general.devWatermark": "開発中バージョン/テクニカルプレビュー\n品質は保証されません （{version}）"
      },
      "en-US": {
        "dialog.generic.ok": "OK",
        "dialog.generic.cancel": "Cancel",
        "dialog.crash.title": "Application crashed (´；ω；`)",
        "dialog.crash.confirm": "Close",
        "dialog.crash.cancel": "Copy error",
        "dialog.multiInstance.title": "Another instance is already running",
        "dialog.multiInstance.text": "An existing instance is already running.\n\nChoose what to do:",
        "dialog.multiInstance.confirm": "Terminate old and run",
        "dialog.multiInstance.cancel": "Exit both",
        "testDialog.title": "Test dialog",
        "testDialog.confirm": "Got it",
        "testDialog.cancel": "Close",
        "dialog.fontWarning.title": "Custom Font Risk Notice",
        "dialog.fontWarning.text": "Enabling custom fonts may cause the following issues:\n\n1. Broken layout, overflowing controls, or unexpected line breaks\n2. Missing glyphs for some characters, symbols, or languages, shown as squares or question marks\n3. Blurry or misaligned text under different DPI or display scaling\n4. Behavior that differs from the developer environment on certain systems or PowerPoint versions\n\nThe developer is not responsible for any visual glitches, crashes, or presentation incidents caused by custom fonts and does not provide dedicated support for such issues.",
        "dialog.fontWarning.confirm": "I understand and accept these risks",
        "general.devWatermark": "In-Development/Technical Preview\nFinal quality not guaranteed ({version})"
      },
      "ug-CN": {
        "dialog.generic.ok": "جەزملەشتۈر",
        "dialog.generic.cancel": "بىكار",
        "dialog.crash.title": "پروگرامما ئۈزۈلۈپ قالدى (´；ω；`)",
        "dialog.crash.confirm": "ياپ",
        "dialog.crash.cancel": "خاتالىقنى كۆچۈرۈش",
        "dialog.multiInstance.title": "باشقا نەشرى ئىشلىۋاتىدۇ",
        "dialog.multiInstance.text": "بىر نەشرى ئاللىقاچان ئىشلىۋاتىدۇ.\n\nنېمە قىلىمىز؟",
        "dialog.multiInstance.confirm": "كونا نەشرىنى توختىتىپ قوزغىتىش",
        "dialog.multiInstance.cancel": "ئىككىلىسىنى تاقاش",
        "testDialog.title": "سىناق سۆزلەشكۈ",
        "testDialog.confirm": "چۈشەندىم",
        "testDialog.cancel": "تاقاش",
        "dialog.fontWarning.title": "خەت نۇسخىسى خەۋپ ئاگاھلاندۇرۇشى",
        "dialog.fontWarning.text": "خاس خەت نۇسخىسىنى قوزغىتىش تۆۋەندىكى مەسىلىلەرنى كەلتۈرۈپ چىقىرىشى مۇمكىن:\n\n1. لايىھە بۇزۇلۇشى ياكى قىسىلىپ كېتىشى\n2. بەزى ھەرپ-بەلگىلەرنىڭ يوقاپ كېتىشى\n3. DPI ياكى كۆرۈنۈش دەرىجىسىگە باغلىق سۈپەت پەرقى\n4. مەلۇم سىستېمىلاردا باشقا نەتىجە كۆرۈنۈشى\n\nبۇنىڭدىن كېلىپ چىققان مەسىلىلەرگە تەرەققىيات تەرەپ مەسئۇلىيەت ئالمايدۇ.",
        "dialog.fontWarning.confirm": "خەۋپنى چۈشەندىم",
        "general.devWatermark": "تېخنىكىلىق ئالدىن كۆرۈش نۇسخىسى\nسۈپەت كاپالەتلەنمەيدۇ ({version})"
      }
    };

    let currentLanguage = "zh-CN";
    let settings = {};

    function updateLanguageAndSettings(s) {
      if (s && typeof s === "object") {
        settings = s;
        window.initialSettings = s;
        if (s.General && s.General.Language) {
          currentLanguage = s.General.Language;
        }
      }
      applyDirection(currentLanguage);
    }

    function getText(key) {
      const langPack = I18N[currentLanguage] || I18N["zh-CN"];
      if (langPack && key in langPack) return langPack[key];
      const fallback = I18N["zh-CN"];
      if (fallback && key in fallback) return fallback[key];
      return "";
    }

    function getDefaultFontStack(lang) {
      const isSpecial = lang === "zh-TW" || lang === "ja-JP";
      if (lang === "zh-TW") {
        return "\"Microsoft JhengHei\", \"MiSans Latin\", \"HarmonyOS Sans TC\", \"SF Pro\", \"苹方-繁\", \"PingFang TC\", system-ui, -apple-system, sans-serif";
      }
      if (lang === "ja-JP") {
        return "\"Yu Gothic UI\", \"Meiryo\", \"MiSans Latin\", \"HarmonyOS Sans JP\", \"SF Pro\", system-ui, -apple-system, sans-serif";
      }
      if (lang === "ug-CN") {
        return "\"Microsoft Uighur\", \"ALKATIP Basma Tom\", \"MiSans Latin\", \"HarmonyOS Sans SC\", \"SF Pro\", system-ui, -apple-system, sans-serif";
      }
      return "\"MiSans Latin\", \"HarmonyOS Sans SC\", \"SF Pro\", \"苹方-简\", \"PingFang SC\", \"Segoe UI\", \"Microsoft YaHei\", system-ui, -apple-system, sans-serif";
    }

    function getSelectedWebFont(lang) {
      const profiles = settings && settings.Fonts && settings.Fonts.Profiles;
      const langProfile = profiles && profiles[lang];
      const v = langProfile && langProfile.web;
      return (typeof v === "string" && v.trim()) ? v.trim() : "";
    }

    function applyLanguageFont(lang) {
      const targetLang = lang || currentLanguage;
      const base = getDefaultFontStack(targetLang);
      const selected = getSelectedWebFont(targetLang);
      const stack = selected ? `"${selected.replace(/"/g, '\\"')}", ${base}` : base;
      document.documentElement.style.setProperty("--font-stack", stack);
      document.documentElement.lang = targetLang;
    }

    function applyDirection(lang) {
      const isRtl = lang === "ug-CN";
      document.documentElement.dir = isRtl ? "rtl" : "ltr";
      document.documentElement.classList.toggle("rtl", isRtl);
    }

    function init(data) {
      const isCrash = !!data.isError;
      const isMulti = data.code === "multi_instance";
      const isTest = data.code === "test_dialog";
      const isFontWarning = data.code === "font_warning";

      // If it's a font warning, we might want to preview a specific language's font
      if (isFontWarning && data.targetLang) {
        applyLanguageFont(data.targetLang);
      } else {
        applyLanguageFont();
      }
      applyDirection(currentLanguage);

      if (!data.title) {
        if (isCrash) {
          data.title = getText("dialog.crash.title") || "程序崩溃了 (´；ω；`) ";
        } else if (isMulti) {
          data.title = getText("dialog.multiInstance.title") || "检测到程序已在运行";
        } else if (isTest) {
          data.title = getText("testDialog.title") || "测试对话框";
        } else if (isFontWarning) {
          data.title = getText("dialog.fontWarning.title") || "自定义字体风险提示";
        }
      }

      if (!data.text) {
        if (isMulti) {
          data.text = getText("dialog.multiInstance.text");
        } else if (isFontWarning) {
          data.text = getText("dialog.fontWarning.text");
        }
      }

      if (!data.confirmText) {
        if (isCrash) {
          data.confirmText = getText("dialog.crash.confirm") || getText("dialog.generic.ok");
        } else if (isMulti) {
          data.confirmText = getText("dialog.multiInstance.confirm") || getText("dialog.generic.ok");
        } else if (isTest) {
          data.confirmText = getText("testDialog.confirm") || getText("dialog.generic.ok");
        } else if (isFontWarning) {
          data.confirmText = getText("dialog.fontWarning.confirm") || getText("dialog.generic.ok");
        } else {
          data.confirmText = getText("dialog.generic.ok") || "确认";
        }
      }

      if (!data.cancelText && !data.hideCancel) {
        if (isCrash) {
          data.cancelText = getText("dialog.crash.cancel") || getText("dialog.generic.cancel");
        } else if (isMulti) {
          data.cancelText = getText("dialog.multiInstance.cancel") || getText("dialog.generic.cancel");
        } else if (isTest) {
          data.cancelText = getText("testDialog.cancel") || getText("dialog.generic.cancel");
        } else {
          data.cancelText = getText("dialog.generic.cancel") || "取消";
        }
      }

      if (data.title) titleEl.innerText = data.title;
      if (data.text) textEl.innerText = data.text;
      if (data.isError) {
        errorEl.innerText = data.text;
        errorEl.style.display = 'block';
        textEl.style.display = 'none';
      }
      if (data.confirmText) btnConfirm.innerText = data.confirmText;
      if (data.cancelText) btnCancel.innerText = data.cancelText;
      if (data.hideCancel) btnCancel.style.display = 'none';
      
      let mode = data.theme || 'light';
      if (mode === 'auto') {
        mode = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      const isDark = mode === 'dark';
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      const accent = isDark ? '#E1EBFF' : '#3275F5';
      document.documentElement.style.setProperty('--accent-blue', accent);
    }

    function onConfirm() {
      if (window.pywebview && window.pywebview.api) {
        window.pywebview.api.on_confirm();
      } else {
        window.close();
      }
    }

    function onCancel() {
      if (errorEl.style.display !== 'none') {
        const text = errorEl.innerText;
        navigator.clipboard.writeText(text).then(() => {
          const originalText = btnCancel.innerText;
          btnCancel.innerText = "已复制！";
          btnCancel.style.color = "#4CAF50";
          setTimeout(() => {
            btnCancel.innerText = originalText;
            btnCancel.style.color = "";
          }, 2000);
        }).catch(err => {
          console.error('Failed to copy: ', err);
          const textArea = document.createElement("textarea");
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            btnCancel.innerText = "已复制！";
          } catch (e) {
            btnCancel.innerText = "复制失败";
          }
          document.body.removeChild(textArea);
        });
        return;
      }

      if (window.pywebview && window.pywebview.api) {
        window.pywebview.api.on_cancel();
      } else {
        window.close();
      }
    }

    function updateTheme(mode) {
      let theme = mode || 'light';
      if (theme === 'auto') {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      const isDark = theme === 'dark';
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      const accent = isDark ? '#E1EBFF' : '#3275F5';
      document.documentElement.style.setProperty('--accent-blue', accent);
    }

    function updateAccentColor() {}

    window.addEventListener('pywebviewready', () => {
      if (window.pywebview && window.pywebview.api) {
        const api = window.pywebview.api;

        const settingsPromise = api.get_settings
          ? api.get_settings().catch(() => null)
          : Promise.resolve(null);

        const dialogPromise = api.get_dialog_data
          ? api.get_dialog_data()
          : Promise.resolve(null);

        Promise.all([settingsPromise, dialogPromise]).then(([s, d]) => {
          if (s) {
            updateLanguageAndSettings(s);
          }
          if (d) {
            init(d);
          }
        });

        if (api.get_version) {
          api.get_version().then(v => {
            if (!v) return;
            const version = v.version || "";
            const wm = document.getElementById("dev-watermark");
            if (wm && version) {
              const parts = String(version).trim().split(".");
              if (parts.length >= 2 && parts[parts.length - 1] === "1") {
                const tmpl = getText("general.devWatermark") || "开发中版本/技术预览版本\n不保证最终品质 （{version}）";
                wm.textContent = tmpl.replace("{version}", version);
                wm.style.display = "block";
              } else {
                wm.style.display = "none";
              }
            }
          }).catch(err => console.error("Failed to get version:", err));
        }
      }
    });
  </script>
</body>
</html>
